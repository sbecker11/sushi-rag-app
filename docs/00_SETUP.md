# Setup & Configuration Guide

Complete setup, configuration, and environment guide for the Sushi RAG App.

## Quick Start

### Prerequisites
- Node.js 16+ installed
- Docker Desktop installed and running
- OpenAI API key (optional, for AI features)

### Installation Steps

```bash
# 1. Install all dependencies
npm run install-all

# 2. Create .env file from template
cp env.example .env

# 3. Edit .env and add your OpenAI API key (optional)
# nano .env

# 4. Set up database (one-time)
npm run db:setup

# 5. Start everything!
npm run dev
```

That's it! The app will be available at:
- **Frontend:** http://localhost:5173
- **Backend API:** http://localhost:3001

---

## Environment Configuration

### .env File Location

Create `.env` in the **root directory** (same level as `docker-compose.yml`):

```
sushi-rag-app/
‚îú‚îÄ‚îÄ .env          ‚Üê HERE!
‚îú‚îÄ‚îÄ backend/
‚îú‚îÄ‚îÄ frontend/
‚îî‚îÄ‚îÄ docker-compose.yml
```

### Complete Environment Template

```env
# Backend Configuration
PORT=3001                                    # Backend server port

# PostgreSQL Docker Container Configuration
POSTGRES_CONTAINER=sushi-rag-app-postgres  # Container name (customizable!)
POSTGRES_USER=sushi_rag_user               # Database user
POSTGRES_PASSWORD=sushi_rag_password       # Database password
POSTGRES_DB=sushi_rag_orders               # Database name
POSTGRES_HOST=localhost                     # Database host
POSTGRES_PORT=5432                          # PostgreSQL port

# ChromaDB Configuration (Vector Database)
CHROMA_HOST=localhost
CHROMA_PORT=8000

# OpenAI Configuration (optional for AI features)
OPENAI_API_KEY=your_openai_api_key_here    # Get from https://platform.openai.com/

# Frontend URL (for CORS)
FRONTEND_URL=http://localhost:5173

# Performance Monitoring (optional)
ENABLE_PERFORMANCE_LOGGING=true            # Set to 'false' to disable timing logs
```

### Default Behavior

If you don't create a `.env` file, everything uses sensible defaults:
- Container: `sushi-rag-app-postgres`
- User: `sushi_rag_user`
- Database: `sushi_rag_orders`
- Ports: `5432` (PostgreSQL), `3001` (Backend), `5173` (Frontend)

**The app will work without `.env`, but you won't have AI features without an OpenAI key.**

---

## ü§ñ OpenAI API Key Setup

### Do I Need It?

**No, it's optional!** The app works perfectly fine without it:
- ‚úÖ **Without key:** Uses static sushi menu (8 pre-configured items)
- ‚ú® **With key:** Menu generated by GPT-4, plus AI assistant chat

### How to Get an OpenAI API Key

#### Step 1: Create Account

1. Go to **https://platform.openai.com/**
2. Click **"Sign Up"** or **"Log In"**
3. Complete registration

#### Step 2: Add Payment Method

**Important**: OpenAI requires a payment method (pay-as-you-go).

1. Go to **https://platform.openai.com/account/billing**
2. Click **"Add payment method"**
3. Enter your credit/debit card information
4. **Optional:** Set usage limits to control costs:
   - Go to **Billing ‚Üí Usage limits**
   - Set a monthly budget (e.g., $5/month)

#### Step 3: Create API Key

1. Navigate to **https://platform.openai.com/api-keys**
2. Click **"Create new secret key"**
3. Name it (e.g., "sushi-rag-app")
4. Copy the key (starts with `sk-` or `sk-proj-`)
5. **IMPORTANT:** Save it securely - you won't see it again!

#### Step 4: Add to .env

Open your `.env` file and replace the placeholder:

```bash
# Before
OPENAI_API_KEY=your_openai_api_key_here

# After (use your actual key)
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

Or use this command (replace with your actual key):

```bash
# On macOS/Linux
sed -i '' 's/OPENAI_API_KEY=.*/OPENAI_API_KEY=sk-proj-your-actual-key-here/' .env
```

#### Step 5: Restart App

```bash
# Stop with Ctrl+C, then:
npm run dev
```

### üí∞ Cost Estimates

Typical usage costs:
- **Menu generation:** $0.01-0.03 per request (cached after first generation)
- **Embeddings:** $0.0001 per item
- **Chat queries:** $0.01-0.03 per conversation
- **Monthly (light use):** $1-5

**Note:** Menu is cached in backend, so it's only generated once until restart.

### üß™ Testing Your API Key

**Option 1: Use the test script (recommended)**

```bash
npm run test:openai
```

This will:
- ‚úÖ Check if your API key is loaded
- ‚úÖ Verify the key format
- ‚úÖ Make a test API call to confirm it works
- ‚úÖ Provide helpful error messages if something is wrong

**Option 2: Check via the running app**

```bash
curl http://localhost:3001/api/menu
```

Look for console messages:
- ‚úÖ `Generated menu from OpenAI LLM` - API key working!
- ‚ÑπÔ∏è `Using static menu` - Using fallback (no key or error)

### üåü Free Alternatives

If you don't want to pay:
1. Use the static menu (works great!)
2. Use OpenAI free trial credits (if available)
3. Use a different LLM provider (requires code changes)

---

## Frontend Environment Behavior

The frontend automatically adjusts security-sensitive features based on the environment mode.

### Credit Card Session Storage

**Development Mode** (`npm run dev`):
- ‚úÖ Credit card numbers are saved to browser `sessionStorage`
- ‚úÖ Pre-fills credit card field on subsequent orders
- ‚úÖ Convenient for rapid testing without re-entering payment info

**Production Mode** (`npm run build` + deployed):
- üîí Credit card numbers are **NOT** saved to `sessionStorage`
- üîí Credit card field is **cleared** after each successful order
- üîí More secure - prevents sensitive data from persisting in the browser

### How It Works

Uses Vite's built-in `import.meta.env.DEV`:
```javascript
// In OrderForm.jsx
if (import.meta.env.DEV) {
  customerInfo.creditCard = formData.creditCard; // Save in dev only
}
```

- `import.meta.env.DEV` is `true` when running `npm run dev`
- `import.meta.env.DEV` is `false` in production builds
- No manual configuration needed - automatically handled by Vite

### Other Session Storage

Customer information (name, phone) is **always** saved to `sessionStorage` in both modes:
- First name
- Last name
- Phone number

Only credit card data is environment-sensitive for security.

---

## How Environment Variables Work

### 1. Docker Compose

Uses environment variable substitution with defaults:
```yaml
container_name: ${POSTGRES_CONTAINER:-sushi-rag-app-postgres}
```

**Syntax:** `${VARIABLE:-default_value}`
- If `POSTGRES_CONTAINER` is set in `.env`, use that
- Otherwise, use `sushi-rag-app-postgres`

### 2. Backend Database Config

```javascript
// backend/config/database.js
const pool = new Pool({
  user: process.env.POSTGRES_USER || 'sushi_rag_user',
  database: process.env.POSTGRES_DB || 'sushi_rag_orders',
  password: process.env.POSTGRES_PASSWORD || 'sushi_rag_password',
  host: process.env.POSTGRES_HOST || 'localhost',
  port: process.env.POSTGRES_PORT || 5432
});
```

### 3. Health Check Scripts

```javascript
// scripts/check-docker.js
import dotenv from 'dotenv';
dotenv.config();

const REQUIRED_SERVICES = [
  process.env.POSTGRES_CONTAINER || 'sushi-rag-app-postgres'
];
```

### Priority Order

**Environment variables are loaded in this order:**
1. Shell environment variables (highest priority)
2. `.env` file
3. Default values in code (lowest priority)

---

## Advanced Configuration

### Custom Container Name

Want a different container name?

```env
POSTGRES_CONTAINER=my-custom-postgres
POSTGRES_USER=sushi_rag_user
POSTGRES_PASSWORD=sushi_rag_password
POSTGRES_DB=sushi_rag_orders
```

### Multiple Developers

Each developer can have different settings without conflicts:

**Alice's .env:**
```env
POSTGRES_CONTAINER=sushi-rag-app-postgres-alice
POSTGRES_PORT=5433
CHROMA_PORT=8001
```

**Bob's .env:**
```env
POSTGRES_CONTAINER=sushi-rag-app-postgres-bob
POSTGRES_PORT=5434
CHROMA_PORT=8002
```

### Multiple Environments

**Development (`.env.dev`):**
```env
PORT=3001
POSTGRES_CONTAINER=sushi-rag-app-postgres-dev
POSTGRES_DB=sushi_rag_orders_dev
ENABLE_PERFORMANCE_LOGGING=true
OPENAI_API_KEY=sk-...
```

**Production (`.env.prod`):**
```env
PORT=3000
POSTGRES_CONTAINER=sushi-rag-app-postgres-prod
POSTGRES_DB=sushi_rag_orders_prod
ENABLE_PERFORMANCE_LOGGING=false
OPENAI_API_KEY=sk-...
```

Switch environments:
```bash
# Development
cp .env.dev .env
npm run dev

# Production
cp .env.prod .env
npm run build && npm start
```

### Override from Command Line

```bash
POSTGRES_CONTAINER=my-temp-db docker-compose up -d
```

### Check Current Configuration

```bash
# See all environment variables Docker Compose will use
docker-compose config

# See specific container name
docker ps --format '{{.Names}}' | grep postgres

# Load and print environment variables
set -a
source .env
set +a
echo "Container: $POSTGRES_CONTAINER"
echo "Database: $POSTGRES_DB"
```

---

## Troubleshooting

### Can't Find .env File

The `.env` file must be in the root directory:
```bash
ls -la .env  # Should show the file
```

If missing, create it:
```bash
cp env.example .env
```

### Environment Variables Not Loading

1. **Check file name**: Must be exactly `.env` (not `.env.txt`)
2. **Check location**: Root directory
3. **Restart services**: Changes require restart
   ```bash
   # Stop: Ctrl+C
   npm run docker:down
   npm run dev
   ```

### Container Name Still Shows Old Name

**Problem:** Changed `POSTGRES_CONTAINER` in `.env` but seeing old container name

**Solution:**
```bash
# Stop and remove old container
docker rm -f sushi-rag-app-postgres

# Start with new name
npm run docker:up
```

### OpenAI API Key Not Working

Check for:
- **Whitespace:** No spaces around the key
- **Quotes:** Don't use quotes: `OPENAI_API_KEY=sk-...` (not `"sk-..."`)
- **Valid key:** Starts with `sk-` or `sk-proj-`
- **Active account:** Check billing at https://platform.openai.com/account/billing
- **Copied entire key:** Make sure you didn't truncate it

### "Invalid API Key" Error

- Verify you copied the entire key (starts with `sk-`)
- Check for extra spaces before/after the key in `.env`
- Verify the key is active in your OpenAI dashboard

### "Insufficient Quota" Error

- Add a payment method to your OpenAI account
- Check your billing limits aren't set too low

### "Rate Limit" Error

- You're making too many requests
- The app caches menus, so this shouldn't happen often
- Wait a minute and try again

### Docker Services Not Found

Make sure Docker Desktop is running:
```bash
open -a Docker
# Wait for green icon in menu bar
npm run dev
```

### Port Already in Use

```bash
# Clean up ports
npm run kill:ports

# Then restart
npm run dev
```

### Verify Environment Setup

After creating `.env`, verify it's working:

```bash
# Start the database
docker-compose up -d

# Check if environment variables are loaded
cd backend
node -e "require('dotenv').config(); console.log(process.env.POSTGRES_USER)"
```

If you see the correct user printed, your environment is configured correctly!

---

## üîí Security Best Practices

1. **Never commit your API key to git** (already in `.gitignore`)
2. **Don't share your `.env` file**
3. **Set usage limits** in your OpenAI dashboard
4. **Rotate keys periodically** for security
5. **Delete unused keys** from the OpenAI dashboard
6. **Always use `.env` files** (never hardcode credentials)
7. **Keep `env.example` updated** with all required variables

---

## Best Practices

### 1. Always Use env.example
Keep `env.example` updated with all required variables and good defaults.

### 2. Don't Commit .env
`.env` should be in `.gitignore` - it contains sensitive data and local preferences.

### 3. Document New Variables
If you add new environment variables, update:
- `env.example`
- This documentation
- README.md

### 4. Use Defaults
Always provide sensible defaults so the app works without `.env`:
```yaml
${POSTGRES_CONTAINER:-sushi-rag-app-postgres}
```

### 5. Validate on Startup
Scripts check and use defaults if variables are missing.

---

## Quick Reference

### Start Application
```bash
npm run dev
```

### Stop Application
```bash
# Press Ctrl+C in terminal
npm run docker:down  # Stop Docker services
```

### Reset Everything
```bash
npm run docker:reset  # Reset Docker with fresh data
npm run db:setup      # Reinitialize database
```

### Check Status
```bash
# Check Docker services
docker ps

# Check AI services
curl http://localhost:3001/api/assistant/status

# Check performance logging
# Look for ‚è±Ô∏è timing logs in backend console
```

### Update Dependencies
```bash
npm run install-all
```

---

## Next Steps

Once setup is complete:

1. ‚úÖ **Test the app:** http://localhost:5173
2. ‚úÖ **Try the AI chat:** Click "ü§ñ Ask AI" button
3. ‚úÖ **Check status:** http://localhost:3001/api/assistant/status
4. üìñ **Learn about Docker workflow:** See `01_DOCKER_WORKFLOW.md`
5. üß™ **Run tests:** See `02_TESTING.md`

---

## Getting Help

If you're stuck:
1. Check this guide's troubleshooting section
2. Review error messages in terminal
3. Check Docker logs: `docker-compose logs`
4. Verify .env configuration
5. Try docker reset: `npm run docker:reset`

**Common issues are usually:**
- Docker not running
- Incorrect .env configuration
- Port conflicts
- Missing OpenAI API key (for AI features)

---

## Summary

| Feature | Description |
|---------|-------------|
| **Location** | `.env` in root directory |
| **Template** | Copy from `env.example` |
| **Required** | OpenAI API key for AI features |
| **Optional** | All other settings have defaults |
| **Security** | Gitignored, not committed to repo |
| **Flexibility** | Per-developer customization |
| **Environment** | DEV/PROD auto-detection (frontend) |

**Quick Setup:**
```bash
cp env.example .env  # Copy template
# Edit .env and add OpenAI key
npm run dev          # Start the app
```

---

## üìû Additional Resources

- **OpenAI Documentation**: https://platform.openai.com/docs
- **OpenAI Community**: https://community.openai.com
- **Pricing Details**: https://openai.com/pricing
- **Docker Compose Docs**: https://docs.docker.com/compose/
- **Node.js Environment Variables**: https://nodejs.org/en/learn/command-line/how-to-read-environment-variables-from-nodejs

